<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de Locales desde Google Sheets - Export corregido</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- leaflet-image -->
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
    #controls { padding:1em; background:#f0f0f0; border-bottom:1px solid #ccc; display:flex; align-items:center; gap:0.6em; flex-wrap:wrap; }
    #map { flex:1; }
    #controls input { padding:0.45em; border-radius:5px; border:1px solid #aaa; }
    button, select { background:#007bff; color:white; border:none; padding:0.5em 1em; border-radius:5px; cursor:pointer; }
    select { background:white; color:black; border:1px solid #ccc; cursor:pointer; }
    .legend { background:white; padding:8px 12px; line-height:1.5; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.3); }
    .legend div { display:flex; align-items:center; gap:5px; }
    .legend-color { width:14px; height:14px; border-radius:50%; display:inline-block; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="btnActualizar">Actualizar datos</button>

    <label><b>Distribuidor:</b></label>
    <select id="filtroDistribuidor"><option value="TODOS">Todos</option></select>

    <input id="buscarUsuario" placeholder="Buscar usuario...">
    <input id="buscarDireccion" placeholder="Buscar direcciÃ³n...">

    <button id="btnExportar">Exportar PNG</button>

    <span id="status">Listo.</span>
  </div>

  <div id="map"></div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNZDex6_PX_Rk4g-XEMCglM1zKfzlYWa_aQHC1_TDvLO4FsTseBsT3Pfpq-YOrh1Me7MdRtb__7pUN/pub?gid=0&single=true&output=csv";

    // ðŸ”¥ preferCanvas: true â†’ garantiza que los markers aparezcan en la exportaciÃ³n
    const map = L.map('map', { preferCanvas: true }).setView([-34.6, -58.38], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors',
      crossOrigin: true
    }).addTo(map);

    // Leyenda
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div><span class="legend-color" style="background:green"></span> Local Creado = SÃ­</div>
        <div><span class="legend-color" style="background:blue"></span> Local Creado = No</div>
        <div><span class="legend-color" style="background:red"></span> Sin informaciÃ³n</div>
      `;
      return div;
    };
    legend.addTo(map);

    const status = document.getElementById('status');
    const btnActualizar = document.getElementById('btnActualizar');
    const btnExportar = document.getElementById('btnExportar');
    const filtroDistribuidor = document.getElementById('filtroDistribuidor');
    const buscarUsuario = document.getElementById("buscarUsuario");
    const buscarDireccion = document.getElementById("buscarDireccion");

    let markersLayer = L.layerGroup().addTo(map);
    let todosLosPuntos = [];

    btnActualizar.addEventListener("click", async () => {
      markersLayer.clearLayers();
      todosLosPuntos = [];
      filtroDistribuidor.innerHTML = `<option value="TODOS">Todos</option>`;
      status.textContent = "Cargando datos desde Google Sheets...";
      const datos = await cargarDatos();
      if (!datos.length) { status.textContent = "No se pudieron obtener los datos."; return; }
      status.textContent = "Generando puntos...";
      mostrarPuntos(datos);
      cargarDistribuidores(datos);
      status.textContent = "Mapa actualizado.";
    });

    async function cargarDatos() {
      try {
        const res = await fetch(SHEET_URL);
        const csv = await res.text();
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        return parsed.data
          .map(row => {
            const lat = parseFloat(row["Latitud"]);
            const lon = parseFloat(row["Longitud"]);
            if (isNaN(lat) || isNaN(lon)) return null;
            return {
              lat, lon,
              usuario: row["USUARIO"] || "",
              distribuidor: row["DISTRIBUIDOR"] || "",
              numero: row["Celular"] || "",
              direccion: row["DirecciÃ³n"] || "",
              localCreado: row["Local Creado"] || ""
            };
          })
          .filter(r => r !== null);
      } catch (e) {
        console.error("Error cargando datos:", e);
        return [];
      }
    }

    function cargarDistribuidores(datos) {
      const unicos = [...new Set(datos.map(d => d.distribuidor).filter(x => x && x.trim() !== ""))];
      unicos.sort().forEach(dist => {
        const opt = document.createElement("option");
        opt.value = dist;
        opt.textContent = dist;
        filtroDistribuidor.appendChild(opt);
      });
    }

    filtroDistribuidor.addEventListener("change", aplicarFiltros);
    buscarUsuario.addEventListener("input", aplicarFiltros);
    buscarDireccion.addEventListener("input", aplicarFiltros);

    function mostrarPuntos(datos) {
      datos.forEach(info => {
        const color = colorPorEstado(info.localCreado);
        const marker = L.circleMarker([info.lat, info.lon], {
          radius: 6,
          fillColor: color,
          color: color,
          fillOpacity: 0.8
        })
        .bindPopup(`
          <b>Usuario:</b> ${info.usuario}<br>
          <b>Distribuidor:</b> ${info.distribuidor}<br>
          <b>NÃºmero:</b> ${info.numero}<br>
          <b>DirecciÃ³n:</b> ${info.direccion}<br>
          <b>Local Creado:</b> ${info.localCreado}
        `)
        .addTo(markersLayer);
        marker._info = info;
        todosLosPuntos.push(marker);
      });
    }

    function aplicarFiltros() {
      const dist = filtroDistribuidor.value;
      const user = buscarUsuario.value.toLowerCase();
      const dir = buscarDireccion.value.toLowerCase();
      todosLosPuntos.forEach(m => {
        const i = m._info;
        const coincideDist = (dist === "TODOS" || i.distribuidor === dist);
        const coincideUser = i.usuario.toLowerCase().includes(user);
        const coincideDir = i.direccion.toLowerCase().includes(dir);
        const visible = coincideDist && coincideUser && coincideDir;
        m.setStyle({ opacity: visible ? 1 : 0, fillOpacity: visible ? 0.8 : 0 });
      });
    }

    function colorPorEstado(valor) {
      const v = (valor || "").toLowerCase();
      if (v === "si" || v === "sÃ­") return "green";
      if (v === "no") return "blue";
      return "red";
    }

    // --------------------------
    // EXPORTACIÃ“N A PNG
    // --------------------------
    btnExportar.addEventListener("click", () => {
      status.textContent = "Generando imagen...";
      try {
        leafletImage(map, function(err, canvas) {
          if (err) {
            console.error("Error al generar imagen:", err);
            status.textContent = "Error al generar imagen.";
            return;
          }

          const dataURL = canvas.toDataURL("image/png");
          const link = document.createElement("a");
          link.download = "mapa_leaflet.png";
          link.href = dataURL;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          status.textContent = "Descarga iniciada.";
        });
      } catch (e) {
        console.error(e);
        status.textContent = "No se pudo generar la imagen.";
      }
    });

    btnActualizar.click();
  </script>
</body>
</html>
